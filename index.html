<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1080, height=1080, initial-scale=1.0, user-scalable=no" />
  <title>Tech Convention Interactive Host</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none}
    body{width:1080px;height:1080px;overflow:hidden;background:#0a0e27;position:relative;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;cursor:none}
    #canvas{position:absolute;top:0;left:0;z-index:1}
    .ui-overlay{position:absolute;top:0;left:0;width:1080px;height:1080px;pointer-events:none;z-index:10;display:flex;flex-direction:column;align-items:center;justify-content:center}
    .greeting-container{position:absolute;top:140px;display:flex;flex-direction:column;align-items:center;opacity:0;transform:translateY(20px);transition:all .6s cubic-bezier(.34,1.56,.64,1)}
    .greeting-container.active{opacity:1;transform:translateY(0)}
    .greeting-text{color:#fff;font-size:52px;font-weight:300;letter-spacing:-1px;margin-bottom:10px;text-align:center}
    .greeting-subtext{color:#64d9ff;font-size:24px;font-weight:500;letter-spacing:2px;text-transform:uppercase}
    .question-container{position:absolute;bottom:160px;left:50%;transform:translateX(-50%);opacity:0;transition:all .5s ease;pointer-events:auto;text-align:center;width:85%}
    .question-container.active{opacity:1}
    .question-text{color:#fff;font-size:42px;font-weight:200;margin-bottom:50px;letter-spacing:.5px}
    .options{display:flex;gap:40px;justify-content:center}
    .option-btn{padding:25px 50px;background:linear-gradient(135deg,rgba(100,217,255,.1),rgba(100,217,255,.05));border:2px solid #64d9ff;border-radius:60px;color:#fff;font-size:24px;font-weight:400;letter-spacing:.5px;cursor:pointer;transition:all .3s ease;position:relative;overflow:hidden;backdrop-filter:blur(10px);min-width:200px}
    .option-btn::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:radial-gradient(circle,rgba(100,217,255,.3),transparent);transform:translate(-50%,-50%);transition:width .6s,height .6s}
    .option-btn:hover{transform:translateY(-3px);background:linear-gradient(135deg,rgba(100,217,255,.2),rgba(100,217,255,.1));box-shadow:0 10px 40px rgba(100,217,255,.3)}
    .option-btn:hover::before{width:300px;height:300px}
    .option-btn:active{transform:translateY(0)}
    .option-btn.positive{border-color:#4ade80;background:linear-gradient(135deg,rgba(74,222,128,.1),rgba(74,222,128,.05))}
    .option-btn.positive:hover{background:linear-gradient(135deg,rgba(74,222,128,.2),rgba(74,222,128,.1));box-shadow:0 10px 40px rgba(74,222,128,.3)}
    .message-display{position:absolute;bottom:100px;left:50%;transform:translateX(-50%) scale(.95);background:linear-gradient(135deg,rgba(100,217,255,.05),rgba(100,217,255,.02));border:1px solid rgba(100,217,255,.3);border-radius:20px;padding:35px 50px;opacity:0;transition:all .5s ease;width:80%;max-width:700px;text-align:center;backdrop-filter:blur(20px)}
    .message-display.active{opacity:1;transform:translateX(-50%) scale(1)}
    .message-text{color:#fff;font-size:28px;font-weight:300;line-height:1.5;letter-spacing:.3px}
    .message-text .highlight{color:#64d9ff;font-weight:400}
    .emoji{font-size:36px;margin:0 8px;display:inline-block;vertical-align:middle}
    @keyframes pulse{0%,100%{opacity:.4}50%{opacity:1}}
    .grid-line{stroke:rgba(100,217,255,.1);stroke-width:1;fill:none}
    .hidden-exit{position:absolute;top:10px;right:10px;width:50px;height:50px;opacity:0;cursor:pointer;z-index:9999}
  </style>
</head>
<body>
  <canvas id="canvas" width="1080" height="1080"></canvas>
  <div class="hidden-exit" onclick="window.close()"></div>

  <div class="ui-overlay">
    <div class="greeting-container" id="greetingContainer">
      <div class="greeting-text" id="greetingText">Welcome to SureFlow</div>
      <div class="greeting-subtext" id="greetingSub" style="display:none;"></div>
    </div>

    <!-- Legacy kept (not used by new flow) -->
    <div class="question-container" id="questionContainer">
      <div class="question-text">How are you today?</div>
      <div class="options">
        <button class="option-btn positive" onclick="handleOption('good')">Great!</button>
        <button class="option-btn" onclick="handleOption('bad')">Could be better</button>
      </div>
    </div>

    <!-- Chocolate flow -->
    <div class="question-container" id="chocoContainer" style="pointer-events:auto;">
      <div class="question-text">Do you want chocolate?</div>
      <div class="options">
        <button class="option-btn positive" id="btnYes">Yes</button>
        <button class="option-btn" id="btnNo">No</button>
      </div>
    </div>

    <div class="message-display" id="messageDisplay">
      <div class="message-text" id="messageText"></div>
    </div>
  </div>

  <script>
    /* ---------- Canvas animation (unchanged) ---------- */
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const centerX = 540, centerY = 540;
    let time = 0, particles = [], aiState = 'idle', pulseIntensity = 0, activeState = false;

    for (let i = 0; i < 60; i++) {
      particles.push({x:Math.random()*1080,y:Math.random()*1080,vx:(Math.random()-0.5)*0.3,vy:(Math.random()-0.5)*0.3,radius:Math.random()*2+1,pulse:Math.random()*Math.PI*2});
    }

    function drawBackground(){
      const g = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, 600);
      g.addColorStop(0,'#0f1729'); g.addColorStop(1,'#0a0e27');
      ctx.fillStyle = g; ctx.fillRect(0,0,1080,1080);
      ctx.strokeStyle='rgba(100,217,255,.03)'; ctx.lineWidth=1;
      for(let r=100;r<540;r+=80){ctx.beginPath();ctx.arc(centerX,centerY,r,0,Math.PI*2);ctx.stroke();}
      for(let a=0;a<Math.PI*2;a+=Math.PI/8){ctx.beginPath();ctx.moveTo(centerX+Math.cos(a)*100,centerY+Math.sin(a)*100);ctx.lineTo(centerX+Math.cos(a)*540,centerY+Math.sin(a)*540);ctx.stroke();}
    }
    function drawParticleNetwork(){
      particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.pulse+=0.02;if(p.x<0||p.x>1080)p.vx*=-1;if(p.y<0||p.y>1080)p.vy*=-1;const dx=p.x-centerX,dy=p.y-centerY,dist=Math.hypot(dx,dy);if(dist>520){p.vx*=-1;p.vy*=-1;}});
      ctx.strokeStyle='rgba(100,217,255,.2)'; ctx.lineWidth=1;
      for(let i=0;i<particles.length;i++){for(let j=i+1;j<particles.length;j++){const dx=particles[i].x-particles[j].x,dy=particles[i].y-particles[j].y,dist=Math.hypot(dx,dy);if(dist<150){ctx.globalAlpha=(1-dist/150)*0.5;ctx.beginPath();ctx.moveTo(particles[i].x,particles[i].y);ctx.lineTo(particles[j].x,particles[j].y);ctx.stroke();}}}
      ctx.globalAlpha=1;
      particles.forEach(p=>{const b=Math.sin(p.pulse)*0.5+0.5;ctx.fillStyle=`rgba(100,217,255,${b*0.8})`;ctx.beginPath();ctx.arc(p.x,p.y,p.radius,0,Math.PI*2);ctx.fill();});
    }
    function drawAICore(){
      const breathe=Math.sin(time*0.02)*10, rotation=time*0.005;
      ctx.strokeStyle='rgba(100,217,255,.3)'; ctx.lineWidth=2;
      for(let i=0;i<3;i++){ctx.save();ctx.translate(centerX,centerY-30);ctx.rotate(rotation+i*Math.PI/3);ctx.beginPath();ctx.arc(0,0,150+i*30+breathe,0,Math.PI*2);ctx.stroke();for(let j=0;j<6;j++){ctx.beginPath();ctx.arc(0,0,150+i*30+breathe,j*Math.PI/3,j*Math.PI/3+Math.PI/6);ctx.strokeStyle=`rgba(100,217,255,${0.5+Math.sin(time*0.05+j)*0.3})`;ctx.stroke();}ctx.restore();}
      const cg=ctx.createRadialGradient(centerX,centerY-30,0,centerX,centerY-30,100+breathe);cg.addColorStop(0,'rgba(100,217,255,.8)');cg.addColorStop(0.5,'rgba(100,217,255,.3)');cg.addColorStop(1,'rgba(100,217,255,0)');ctx.fillStyle=cg;ctx.beginPath();ctx.arc(centerX,centerY-30,100+breathe,0,Math.PI*2);ctx.fill();
      pulseIntensity=activeState?Math.min(pulseIntensity+0.05,1):Math.max(pulseIntensity-0.02,0);
      if(pulseIntensity>0){ctx.strokeStyle=`rgba(100,217,255,${pulseIntensity})`;ctx.lineWidth=3;for(let i=0;i<5;i++){const radius=30+i*15,wave=Math.sin(time*0.1-i*0.5)*10;ctx.beginPath();for(let ang=0;ang<Math.PI*2;ang+=0.1){const r=radius+Math.sin(ang*8+time*0.1)*wave*pulseIntensity;const x=centerX+Math.cos(ang)*r,y=centerY-30+Math.sin(ang)*r;if(ang===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);}ctx.closePath();ctx.stroke();}}
      const eyeY=centerY-30,eyeSpacing=40;[-1,1].forEach(side=>{const eyeX=centerX+side*eyeSpacing;ctx.strokeStyle='rgba(100,217,255,.8)';ctx.lineWidth=2;ctx.beginPath();ctx.arc(eyeX,eyeY,15,0,Math.PI*2);ctx.stroke();const blink=Math.sin(time*0.03+side)*0.5+0.5;ctx.fillStyle=`rgba(100,217,255,${0.5+blink*0.5})`;ctx.beginPath();ctx.arc(eyeX,eyeY,5,0,Math.PI*2);ctx.fill();});
    }
    function animate(){time++;drawBackground();drawParticleNetwork();drawAICore();requestAnimationFrame(animate);} animate();

    /* ---------- UI state machine ---------- */
    const greetingContainer=document.getElementById('greetingContainer');
    const greetingText=document.getElementById('greetingText');
    const questionContainer=document.getElementById('questionContainer'); // legacy
    const chocoContainer=document.getElementById('chocoContainer');
    const btnYes=document.getElementById('btnYes');
    const btnNo=document.getElementById('btnNo');
    const messageDisplay=document.getElementById('messageDisplay');
    const messageText=document.getElementById('messageText');

    let appState='welcome';
    let timers=[];

    function show(el){el.classList.add('active');}
    function hide(el){el.classList.remove('active');}
    function clearTimers(){timers.forEach(t=>clearTimeout(t));timers=[];}

    function resetToWelcome(){
      clearTimers(); appState='welcome'; activeState=false;
      hide(chocoContainer); hide(questionContainer); hide(messageDisplay);
      greetingText.textContent='Welcome to SureFlow'; show(greetingContainer);
      aiState='welcome';
    }
    function proceedToChocolateQuestion(){
      hide(greetingContainer); messageText.textContent=''; hide(messageDisplay);
      setTimeout(()=>{ show(chocoContainer); appState='choco'; aiState='prompt'; }, 300);
    }

    function handleChocolateYes(){
      // Send signal to backend
      wsSend({type:'YesChocolate'});
      activeState=true;

      hide(chocoContainer);
      messageText.innerHTML=`Dispensing <span class="highlight">Chocolate</span>...`;
      show(messageDisplay);
      appState='dispensing';

      // 10s â†’ Thank you â†’ 3s â†’ send NoChocolate â†’ reset
      timers.push(setTimeout(()=>{
        messageText.textContent='Thank you for visiting us!';
        timers.push(setTimeout(()=>{
          wsSend({type:'NoChocolate'}); // final signal after thank-you
          hide(messageDisplay);
          setTimeout(resetToWelcome, 600);
        }, 3000));
      }, 10000));
    }

    function handleChocolateNo(){
      wsSend({type:'NoChocolate'}); // logs "Moving robot back" in backend
      activeState=false;
      hide(chocoContainer);
      messageText.textContent='See you!';
      show(messageDisplay);
      appState='seeYou';
      timers.push(setTimeout(()=>{ hide(messageDisplay); setTimeout(resetToWelcome, 600); }, 2500));
    }

    // Legacy handlers (kept, not used)
    function handleOption(choice){
      activeState=true; hide(questionContainer);
      if(choice==='good'){
        messageText.innerHTML=`Excellent! Our team has prepared <span class="highlight">cutting-edge demos</span> just for you.`; show(messageDisplay);
        timers.push(setTimeout(()=>{ messageText.innerHTML=`Grab a <span class="highlight">chocolate</span> and <span class="highlight">info packet</span> at our booth! <span class="emoji">ðŸš€</span>`; }, 3500));
      } else {
        messageText.innerHTML=`We understand. Tech can be overwhelming sometimes.`; show(messageDisplay);
        timers.push(setTimeout(()=>{ messageText.innerHTML=`Take <span class="highlight">two chocolates</span> - they're debug-tested for happiness! <span class="emoji">ðŸ’™</span>`; }, 3500));
      }
      timers.push(setTimeout(()=>{ hide(messageDisplay); activeState=false; }, 7000));
    }

    /* ---------- WebSocket wiring ---------- */
    const BACKEND_WS_URL = "ws://localhost:8000/ws"; // change if needed
    let ws;
    let wsReady = false;
    let wsRetryTimer;

    function initWS(){
      try {
        ws = new WebSocket(BACKEND_WS_URL);

        ws.addEventListener('open', ()=>{ wsReady = true; /* console.log('WS connected'); */ });
        ws.addEventListener('close', ()=>{
          wsReady = false;
          // try reconnect
          clearTimeout(wsRetryTimer);
          wsRetryTimer = setTimeout(initWS, 1500);
        });
        ws.addEventListener('error', ()=>{ wsReady = false; try{ws.close()}catch{} });
        ws.addEventListener('message', (evt)=>{
          try {
            const data = JSON.parse(evt.data);
            // BACKEND â†’ FRONTEND signal
            if (data.type === 'GreetingTransition' && appState === 'welcome') {
              proceedToChocolateQuestion();
            }
          } catch (e) { /* ignore */ }
        });
      } catch (e) {
        wsReady = false;
        clearTimeout(wsRetryTimer);
        wsRetryTimer = setTimeout(initWS, 2000);
      }
    }
    function wsSend(obj){
      if(wsReady && ws && ws.readyState===WebSocket.OPEN){
        ws.send(JSON.stringify(obj));
      } else {
        // Optionally queue or just drop
        // console.warn('WS not ready; dropping message', obj);
      }
    }

    // Button events
    btnYes.addEventListener('click', handleChocolateYes);
    btnNo.addEventListener('click', handleChocolateNo);

    // Start
    resetToWelcome();
    initWS();

    // Idle safety reset
    let idleTimer;
    function resetIdleTimer(){
      clearTimeout(idleTimer);
      idleTimer = setTimeout(()=>{ resetToWelcome(); }, 30000);
    }
    document.addEventListener('click', resetIdleTimer);
    document.addEventListener('keydown', resetIdleTimer);
    resetIdleTimer();
  </script>
</body>
</html>
